--THIS SCRIPT SHOULD BE INSERTED IN A NEW MODULE UNDER ServerScriptService/ServerHandler


-- Services
local playerService = game:GetService("Players")
local replicatedStorage = game:GetService("ReplicatedStorage")

-- RemoteEvents
local hitRemote = replicatedStorage.Hit
local replicateRemote = replicatedStorage.Replicate

-- Modules
local dataMod = require(script.Parent.Data)

-- Weapons module table
local weapons = {}

-- Utility: Get player and character from hit part
weapons.playerFromHit = function(hit)
	local char = hit:FindFirstAncestorOfClass("Model")
	local player = playerService:GetPlayerFromCharacter(char)
	return player, char
end

-- Angle threshold for hit verification (anti-cheat)
local SECURITY_ANGLE = 15

-- Server-side hit verification using angle comparison
local function verifyHit(hit, direction, origin, relCFrame, gunSettings)
	local target = (hit.CFrame * relCFrame).p
	local serverDirection = target - origin

	-- Reject hits beyond weapon range
	if serverDirection.Magnitude > gunSettings.range then return end

	-- Reject zero-length vectors
	if serverDirection.Magnitude == 0 or direction.Magnitude == 0 then return end

	-- Calculate angle between client and server vectors
	local combinedVectors = serverDirection:Dot(direction)
	local angle = combinedVectors / (direction.Magnitude * serverDirection.Magnitude)

	-- Clamp and convert to degrees
	if angle > 1 then
		angle = 0
	elseif angle < -1 then
		angle = math.pi
	else
		angle = math.acos(angle)
	end
	angle = math.deg(angle)

	-- Accept hit if angle is within threshold
	if angle <= SECURITY_ANGLE then
		return true
	end
end

-- Handle hit registration from client
hitRemote.OnServerEvent:Connect(function(player, weapon, hit, direction, origin, relCFrame)
	local otherPlayer, char = weapons.playerFromHit(hit)

	-- Validate target and debounce
	if char and char:FindFirstChildOfClass("Humanoid") and not weapon.Debounce.Value then
		local gunSettings = require(weapon.Settings)

		-- Verify hit legitimacy
		if verifyHit(hit, direction, origin, relCFrame, gunSettings) then
			-- Apply debounce based on rate of fire
			weapon.Debounce.Value = true
			local waitTime = 60 / gunSettings.rateOfFire
			delay(waitTime, function()
				weapon.Debounce.Value = false
			end)

			-- Apply damage
			local hum = char:FindFirstChildOfClass("Humanoid")
			if hum.Health > 0 then
				local damage = gunSettings.damage
				if hit.Name == "Head" then
					damage = damage * gunSettings.headshotMultiplier
				end

				hum.Health = hum.Health - damage

				-- Track kill if target dies
				if hum.Health <= 0 then
					dataMod.increment(player, "Kills", 1)
				end
			end
		end
	end
end)

-- Handle visual replication of shots
replicateRemote.OnServerEvent:Connect(function(player, weapon, origin, target)
	local length = (target - origin).Magnitude
	local visualCFrame = CFrame.new(origin, target) * CFrame.new(0, 0, -length / 2)
	local gunSettings = require(weapon.Settings)

	-- Broadcast visual effect to all clients
	replicatedStorage.Replicate:FireAllClients(player, gunSettings, visualCFrame, length)
end)

return weapons
